# ImmuneMethylTools

A DNA Methylation QC Pipeline for Autoimmune Disease Research.

ImmuneMethylTools is a pipeline designed to identify and mitigate common wet-lab and bioinformatics artifacts in DNA methylation data with an eye towards immmune applications. 
It provides quality control, data cleaning, and leverages advanced statistical modeling (OLS/Wilcoxon) to isolate true biological signals.

## Cleaning the data first

Before any biology can be found, five QC stages remove or remediate artifacts that would otherwise corrupt downstream results:

1. **Sample QC:** Bisulfite conversion rate & mean depth filters.
2. **Signal Quality:** Contamination detection (bimodality) & sex-metadata (XCI) verification.
3. **Sample Integrity:** Technical duplicate detection (Pearson correlation).
4. **Surgical Remediation:** Site-level depth filtering & VDJ-locus beta masking for clonal samples.
5. **Normalization:** Confound detection (Batch/Age/Sex) followed by median-centering.

## Finding the biology

Once the data is clean, two methods interrogate it for true disease signal:

- **Covariate-adjusted DMR calling (OLS):** CpGs are grouped into distance-based clusters. For each cluster, an OLS model tests the disease coefficient after regressing out age and sex, using logit-transformed M-values to satisfy normality assumptions. Delta-beta is reported on the original beta scale for interpretability. BH correction is applied across all clusters.
- **Leak-free ML validation (ElasticNet):** A GroupKFold cross-validated ElasticNet classifier is trained on batch-corrected (`beta_normalized`) features. Keeping patients out of both train and test folds prevents pseudoreplication from inflating AUC. Feature weights are exported so the top predictive CpGs can be compared against DMR hits.

## Example outputs

### Batch & covariate structure (PCA)

![PCA covariates](output/figures/pca_covariates.png)

Each panel colors the same PCA projection by a different covariate. A tight cluster by batch with no separation by disease label would indicate the classifier is learning batch identity rather than biology. After median-centering, disease label should drive PC separation while batch, sex, and age remain evenly distributed across the plot.

### DMR volcano

![Volcano plot](output/figures/volcano.png)

Each point is a CpG cluster tested by OLS. The x-axis is delta-beta (Case − Control, batch-corrected scale); the y-axis is −log10(BH-adjusted p-value). Red points exceed both the delta-beta threshold (≥ 0.10) and significance threshold (p_adj < 0.05). The single red cluster at chr6:30 Mb is the injected positive control; all other clusters correctly fall below the thresholds.

## Quick Start

```bash
# 1. Setup Environment
bash setup.sh                        # creates venv, installs requirements.txt
source venv/bin/activate

# 2. Generate Mock Data
python data/generate_mock_data.py

# 3. Run Pipeline (Generates PDF Report)
python core/orchestration/pipeline.py --report
```

> `requirements.txt` is autogenerated from `pyproject.toml` via `pip-compile` and should not be edited by hand.
> To regenerate after updating `pyproject.toml`: `pip-compile pyproject.toml --output-file requirements.txt --no-annotate`

## The Artifact Map: What we catch

ImmuneMethylTools is built to survive "stumper" artifacts common in immune-cell studies:

| # | Artifact | Key Signal | Remediation |
|---|----------|------------|-------------|
| 1 | **Bisulfite Failure** | non-CpG meth > 2% | Drop Sample |
| 2 | **Low Coverage** | Mean depth < 10x | Drop Sample |
| 3 | **Contamination** | "Muddy" beta (near 0.5) | Drop Sample |
| 4 | **Sex-Metadata Mixup** | XCI signal mismatch | Drop Sample |
| 5 | **Duplicates** | Pearson r > 0.99 | Drop Replicate |
| 6 | **Clonal VDJ** | High Beta + Long Fragment | **Mask Locus** (Keep Sample) |
| 7 | **Batch Confound** | High Cramér's V (Batch × Disease) | Median-Centring |
| 8 | **Lineage Anomaly** | FoxP3/PAX5 proxy beta shift | Flag (Treg-enriched / B-cell depleted) |

---

**For the full Technical Manual, including SOPs on Masking vs. Dropping, Cell-Type Deconvolution, and Configurable Thresholds, see [TECHNICAL_GUIDE.md](TECHNICAL_GUIDE.md).**
